<script context="module">
  // Function to check node type
  function isNodeType(editor, node, type, attrs = {}) {
    if (!editor || !node) return false;
    
    if (type === 'paragraph') {
      return node.type.name === 'paragraph';
    } else if (type === 'heading') {
      return node.type.name === 'heading' && node.attrs.level === attrs.level;
    } else if (type === 'bulletList') {
      return node.type.name === 'bulletList' || 
        (node.type.name === 'listItem' && node.parent?.type.name === 'bulletList');
    } else if (type === 'orderedList') {
      return node.type.name === 'orderedList' || 
        (node.type.name === 'listItem' && node.parent?.type.name === 'orderedList');
    } else if (type === 'taskList') {
      return node.type.name === 'taskList' || 
        (node.type.name === 'taskItem' && node.parent?.type.name === 'taskList');
    }
    return false;
  }

  // Menu item styling function
  function styleMenuItem(btn, icon) {
    btn.style.display = 'flex';
    btn.style.alignItems = 'center';
    btn.style.gap = '4px';
    btn.style.padding = '6px 8px';
    btn.style.border = 'none';
    btn.style.borderRadius = '4px';
    btn.style.background = 'transparent';
    btn.style.cursor = 'pointer';
    btn.style.width = '100%';
    btn.style.textAlign = 'left';
    btn.style.fontSize = '14px';
    btn.style.color = '#333';
    
    if (icon) {
      const iconSpan = document.createElement('span');
      iconSpan.innerHTML = icon;
      iconSpan.style.display = 'inline-flex';
      iconSpan.style.width = '20px';
      iconSpan.style.height = '20px';
      iconSpan.style.alignItems = 'center';
      iconSpan.style.justifyContent = 'center';
      btn.prepend(iconSpan);
    }
    
    btn.onmouseover = () => {
      btn.style.background = '#f5f5f5';
    };
    btn.onmouseout = () => {
      btn.style.background = 'transparent';
    };
  }

  // Menu item active styling function
  function styleActiveMenuItem(btn, isActive) {
    if (isActive) {
      btn.style.background = '#f0f0f0';
      btn.style.fontWeight = 'bold';
      
      // Add check icon
      const checkIcon = document.createElement('span');
      checkIcon.innerHTML = '✓';
      checkIcon.style.marginLeft = 'auto';
      checkIcon.style.color = '#4caf50';
      btn.appendChild(checkIcon);
    }
  }

  // Add divider function
  function addDivider(menu) {
    const divider = document.createElement('div');
    divider.style.height = '1px';
    divider.style.background = '#eee';
    divider.style.margin = '4px 0';
    menu.appendChild(divider);
  }

  // Show line menu function
  export function showLineMenu(x, y, editor, node, pos, openSidebarCallback) {
    console.log('showLineMenu 호출됨', { x, y, editor, node, pos });
    
    const oldMenu = document.getElementById('line-menu-popup');
    if (oldMenu) {
      oldMenu.remove();
    }
    
    const menu = document.createElement('div');
    menu.id = 'line-menu-popup';
    menu.style.position = 'absolute';
    menu.style.left = x + 'px';
    menu.style.top = y + 'px';
    menu.style.transform = 'translateY(10px)';
    menu.style.padding = '8px';
    menu.style.border = '1px solid #eee';
    menu.style.background = '#fff';
    menu.style.zIndex = '9999';
    menu.style.borderRadius = '6px';
    menu.style.boxShadow = '0 2px 10px rgba(0,0,0,0.1)';
    menu.style.display = 'flex';
    menu.style.flexDirection = 'column';
    menu.style.gap = '4px';
    menu.style.minWidth = '180px';
    menu.style.maxWidth = '220px';
    menu.style.fontSize = '14px';
    
    
    // Paragraph
    const paragraphBtn = document.createElement('button');
    paragraphBtn.textContent = '본문';
    styleMenuItem(paragraphBtn, '<svg width="16" height="16" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><text x="8" y="17" font-size="16" font-weight="bold" fill="currentColor">P</text></svg>');
    styleActiveMenuItem(paragraphBtn, isNodeType(editor, node, 'paragraph'));
    paragraphBtn.onclick = () => {
      try {
        console.log('본문 버튼 클릭됨');
        editor.chain().focus().setNode('paragraph').run();
      } catch (error) {
        console.error('본문 변환 중 오류:', error);
      }
      closeMenu();
    };
    menu.appendChild(paragraphBtn);
    
    // Heading 1
    const heading1Btn = document.createElement('button');
    heading1Btn.textContent = '제목1';
    styleMenuItem(heading1Btn, '<svg width="16" height="16" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M6 4v16M18 4v16M6 12h12" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/></svg>');
    styleActiveMenuItem(heading1Btn, isNodeType(editor, node, 'heading', { level: 1 }));
    heading1Btn.onclick = () => {
      try {
        console.log('제목1 버튼 클릭됨');
        editor.chain().focus().setNode('heading', { level: 1 }).run();
      } catch (error) {
        console.error('제목1 변환 중 오류:', error);
      }
      closeMenu();
    };
    menu.appendChild(heading1Btn);
    
    // Heading 2
    const heading2Btn = document.createElement('button');
    heading2Btn.textContent = '제목2';
    styleMenuItem(heading2Btn, '<svg width="16" height="16" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M6 4v16M18 4v16M6 12h12" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/></svg>');
    styleActiveMenuItem(heading2Btn, isNodeType(editor, node, 'heading', { level: 2 }));
    heading2Btn.onclick = () => {
      try {
        console.log('제목2 버튼 클릭됨');
        editor.chain().focus().setNode('heading', { level: 2 }).run();
      } catch (error) {
        console.error('제목2 변환 중 오류:', error);
      }
      closeMenu();
    };
    menu.appendChild(heading2Btn);
    
    // Heading 3
    const heading3Btn = document.createElement('button');
    heading3Btn.textContent = '제목3';
    styleMenuItem(heading3Btn, '<svg width="16" height="16" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M6 4v16M18 4v16M6 12h12" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/></svg>');
    styleActiveMenuItem(heading3Btn, isNodeType(editor, node, 'heading', { level: 3 }));
    heading3Btn.onclick = () => {
      try {
        console.log('제목3 버튼 클릭됨');
        editor.chain().focus().setNode('heading', { level: 3 }).run();
      } catch (error) {
        console.error('제목3 변환 중 오류:', error);
      }
      closeMenu();
    };
    menu.appendChild(heading3Btn);
    
    addDivider(menu);
    
    // Bullet list
    const bulletBtn = document.createElement('button');
    bulletBtn.textContent = '글머리 기호';
    styleMenuItem(bulletBtn, '<svg width="16" height="16" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M8 6h13M8 12h13M8 18h13M3 6h.01M3 12h.01M3 18h.01" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/></svg>');
    styleActiveMenuItem(bulletBtn, isNodeType(editor, node, 'bulletList'));
    bulletBtn.onclick = () => {
      try {
        console.log('글머리 기호 버튼 클릭됨');
        editor.chain().focus().toggleBulletList().run();
      } catch (error) {
        console.error('글머리 기호 변환 중 오류:', error);
      }
      closeMenu();
    };
    menu.appendChild(bulletBtn);
    
    // Ordered list
    const orderedBtn = document.createElement('button');
    orderedBtn.textContent = '번호 매기기';
    styleMenuItem(orderedBtn, '<svg width="16" height="16" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M10 6h11M10 12h11M10 18h11M4 6h1v4M4 10h2M4 18h3M4 14h2v4" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/></svg>');
    styleActiveMenuItem(orderedBtn, isNodeType(editor, node, 'orderedList'));
    orderedBtn.onclick = () => {
      try {
        console.log('번호 매기기 버튼 클릭됨');
        editor.chain().focus().toggleOrderedList().run();
      } catch (error) {
        console.error('번호 매기기 변환 중 오류:', error);
      }
      closeMenu();
    };
    menu.appendChild(orderedBtn);
    
    // Tasks list
    const tasksBtn = document.createElement('button');
    tasksBtn.textContent = '할 일 목록';
    styleMenuItem(tasksBtn, '<svg width="16" height="16" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M9 12l2 2 4-4M8 6h13M8 18h13" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/><rect x="3" y="6" width="4" height="4" rx="1" stroke="currentColor" stroke-width="2"/><rect x="3" y="16" width="4" height="4" rx="1" stroke="currentColor" stroke-width="2"/></svg>');
    tasksBtn.onclick = () => {
      try {
        console.log('할 일 목록 버튼 클릭됨');
        editor.chain().focus().toggleTaskList().run();
      } catch (error) {
        console.error('할 일 목록 변환 중 오류:', error);
      }
      closeMenu();
    };
    menu.appendChild(tasksBtn);
    
    document.body.appendChild(menu);
    
    function handleClickOutside(e) {
      if (!menu.contains(e.target)) {
        closeMenu();
      }
    }
    document.addEventListener('mousedown', handleClickOutside);
    
    function closeMenu() {
      menu.remove();
      document.removeEventListener('mousedown', handleClickOutside);
            
      if (typeof openSidebarCallback === 'function') {
        openSidebarCallback();
      }
    }
    
    return { closeMenu };
  }

</script>

<script>
  // This component doesn't need to render anything, it's just a module to export functions
</script>

<style>
  /* 라인 아이콘 스타일 */
  :global(.line-icon) {
    position: absolute;
    left: -24px;
    width: 24px;
    height: 24px;
    display: flex;
    align-items: center;
    justify-content: center;
    opacity: 0;
    transition: opacity 0.2s, background-color 0.2s;
    border-radius: 4px;
    cursor: pointer;
    color: #555;
  }
  
  :global(.add-line-icon) {
    position: absolute;
    width: 24px;
    height: 24px;
    display: flex;
    align-items: center;
    justify-content: center;
    opacity: 0;
    transition: opacity 0.2s, background-color 0.2s;
    border-radius: 4px;
    cursor: pointer;
    color: #555;
  }
  
  :global(.line-block:hover .line-icon),
  :global(.line-block:hover .add-line-icon) {
    opacity: 0.7;
  }
  
  :global(.line-icon:hover),
  :global(.add-line-icon:hover) {
    opacity: 1 !important;
    background-color: rgba(0, 0, 0, 0.05);
  }
  
  /* 메뉴 스타일 */
  :global(#line-menu-popup),
  :global(#add-menu-popup) {
    animation: fadeIn 0.15s ease-in-out;
    box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
    border: 1px solid #eee;
  }
  
  :global(#line-menu-popup button),
  :global(#add-menu-popup button) {
    display: flex;
    align-items: center;
    gap: 2px;
    width: 100%;
    text-align: left;
    padding: 6px 8px;
    border: none;
    background: transparent;
    border-radius: 4px;
    cursor: pointer;
    transition: background-color 0.2s;
  }
  
  :global(#line-menu-popup button:hover),
  :global(#add-menu-popup button:hover) {
    background-color: rgba(0, 0, 0, 0.05);
  }
  
  :global(#line-menu-popup button.active),
  :global(#add-menu-popup button.active) {
    background-color: rgba(0, 0, 0, 0.08);
    font-weight: 500;
  }
  
  @keyframes fadeIn {
    from { opacity: 0; transform: translateY(5px); }
    to { opacity: 1; transform: translateY(0); }
  }
  
  :global(.line-block) {
    position: relative;
    margin-left: 5px;
    padding-left: 5px;
    border-radius: 3px;
    transition: background-color 0.2s ease;
  }
</style> 